# CodeMind 系统架构文档

## 系统概述

CodeMind是一个智能编程推荐系统，核心目标是理解开发者的编程上下文和任务阶段，提供智能的问题推荐。

## 核心模块设计

### 1. 输入感知器（Input Perception）

**功能**: 捕捉用户当前问题 + IDE编程上下文

**输入**:
- 用户问题文本
- 当前文件路径
- 光标位置
- 当前函数/类名

**输出**:
- 结构化的问题对象
- 提取的实体（函数名、模块、异常等）
- 上下文信息

**实现要点**:
- 使用NLP技术提取问题中的关键实体
- 分析问题类型（疑问句、陈述句等）
- 提取代码相关的关键词

### 2. 对话状态建模器（Dialog Tracker）

**功能**: 保存近N轮对话，构建任务状态图

**数据结构**:
```python
class DialogState:
    conversation_history: List[Message]
    current_task: Task
    task_progress: float  # 0-1
    context_entities: Set[str]
```

**实现要点**:
- 维护对话历史（最近10轮）
- 识别任务是否已完成
- 跟踪上下文实体的变化

### 3. 代码焦点提取器（Code Context Extractor）

**功能**: 提取当前代码文件结构、所在函数、周边API

**输入**:
- 文件路径
- 光标位置

**输出**:
- 当前函数/类信息
- 周边代码结构
- 依赖关系

**实现要点**:
- 使用AST解析代码结构
- 提取函数签名和文档字符串
- 分析代码依赖关系

### 4. 任务阶段分类器（Task Stage Classifier）

**功能**: 将问题归类为不同任务类型

**分类类型**:
- **认知类**: 解释功能/模块（关键词：是什么、解释、说明）
- **设计类**: 功能扩展、模块选型（关键词：如何、怎么、建议）
- **Debug类**: 错误定位（关键词：错误、异常、问题）
- **重构类**: 代码优化（关键词：优化、改进、重构）

**实现要点**:
- 基于关键词的规则分类
- 结合语义相似度
- 支持多标签分类

### 5. 语义匹配器（Semantic Matcher）

**功能**: 与FAQ、文档、历史对话构建向量索引

**实现要点**:
- 使用向量数据库存储历史对话
- 计算语义相似度
- 支持模糊匹配

### 6. 目标规划器（Goal Planner）

**功能**: 基于目标图谱与上下文状态，规划下一个推荐路径

**策略**:
- 从"这个类是做什么的？" → "它在哪些模块被调用过？"
- 从"这个函数报错" → "这个函数在哪里被调用？"
- 从"如何优化性能" → "有哪些常见的性能瓶颈？"

### 7. 候选问题生成器（Question Generator）

**功能**: 模板驱动 + LLM生成

**生成策略**:
1. **模板驱动**: 预定义问题模板 + 实体填充
2. **LLM增强**: 使用GPT/Deepseek API生成更自然的问题
3. **混合策略**: 结合模板和LLM生成

**模板示例**:
- "这个{entity}的{aspect}是什么？"
- "如何{action}这个{entity}？"
- "这个{entity}在哪些地方被使用？"

### 8. 多因素排序器（Ranker）

**功能**: 综合打分排序

**评分因素**:
- 语义相关度 (30%)
- 实体对齐度 (25%)
- 用户历史偏好 (20%)
- 冗余度惩罚 (15%)
- 上下游连贯度 (10%)

### 9. 反馈学习模块（Feedback Engine）

**功能**: 用户操作行为日志，驱动排序器/生成器微调

**收集数据**:
- 用户点击行为
- 忽略行为
- 跳过行为
- 后续对话质量

## 数据流设计

```
用户输入 → 输入感知器 → 对话状态建模器
    ↓
代码焦点提取器 → 任务阶段分类器
    ↓
语义匹配器 → 目标规划器 → 候选问题生成器
    ↓
多因素排序器 → 前端展示
    ↓
反馈学习模块 ← 用户行为
```

## 技术选型

### 后端技术栈
- **Web框架**: FastAPI
- **AI/ML**: OpenAI API, sentence-transformers
- **数据库**: SQLite + ChromaDB (向量数据库)
- **代码分析**: ast, jedi
- **NLP**: spaCy, NLTK

### 前端技术栈
- **框架**: React + TypeScript
- **UI库**: Ant Design / Material-UI
- **状态管理**: Zustand
- **HTTP客户端**: Axios

## 性能考虑

1. **缓存策略**: 对话历史缓存，避免重复计算
2. **异步处理**: 推荐生成异步处理，不阻塞主对话
3. **批量处理**: 向量计算批量处理
4. **资源优化**: 代码分析结果缓存

## 扩展性设计

1. **插件化架构**: 各模块可独立替换
2. **配置驱动**: 通过配置文件调整参数
3. **API设计**: 支持外部系统集成
4. **多语言支持**: 预留国际化接口 